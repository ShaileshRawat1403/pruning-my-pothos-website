---
interface Props {
  title: string;
  pdfUrl: string;
  coverUrl?: string;
  highlights?: string[];
}

const { title, pdfUrl, coverUrl, highlights = [] } = Astro.props;
const modalKeyBase = title
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '-')
  .replace(/(^-|-$)/g, '');
const modalId = `resource-pdf-modal-${modalKeyBase || 'entry'}`;
const modalTitleId = `${modalId}-title`;
---

<section class="resource-pdf" aria-label={`${title} PDF resource`} data-resource-pdf data-pdf-url={pdfUrl}>
  {coverUrl ? (
    <img class="resource-pdf-cover" src={coverUrl} alt={`Cover image for ${title}`} loading="lazy" />
  ) : null}

  {highlights.length ? (
    <section class="resource-summary" aria-label={`${title} key points`}>
      <h3>What this deck covers</h3>
      <ul>
        {highlights.map((item) => (
          <li>{item}</li>
        ))}
      </ul>
    </section>
  ) : null}

  <div class="resource-pdf-actions">
    <button class="resource-pdf-btn" type="button" data-open-modal aria-controls={modalId}>
      Preview
    </button>
    <a class="resource-pdf-btn" href={pdfUrl} target="_blank" rel="noopener noreferrer">Open PDF</a>
    <a class="resource-pdf-btn resource-pdf-btn-secondary" href={pdfUrl} download>Download</a>
  </div>

  <div class="resource-pdf-modal" id={modalId} hidden>
    <div class="resource-pdf-backdrop" data-close-modal></div>
    <section class="resource-pdf-panel" role="dialog" aria-modal="true" aria-labelledby={modalTitleId}>
      <header class="resource-pdf-header">
        <h3 id={modalTitleId}>{title}</h3>
        <div class="resource-pdf-controls" role="toolbar" aria-label="Preview controls">
          <button type="button" data-action="prev-page" aria-label="Previous page" class="pdf-icon-btn">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M15 5l-7 7 7 7" />
            </svg>
            <span class="sr-only">Previous page</span>
          </button>
          <span class="pdf-status" data-role="page">1 / 1</span>
          <button type="button" data-action="next-page" aria-label="Next page" class="pdf-icon-btn">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M9 5l7 7-7 7" />
            </svg>
            <span class="sr-only">Next page</span>
          </button>
          <button type="button" data-action="zoom-out" aria-label="Zoom out" class="pdf-icon-btn">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M5 12h10" />
              <circle cx="11" cy="11" r="7" />
              <path d="M16.5 16.5L21 21" />
            </svg>
            <span class="sr-only">Zoom out</span>
          </button>
          <span class="pdf-status" data-role="zoom">100%</span>
          <button type="button" data-action="zoom-in" aria-label="Zoom in" class="pdf-icon-btn">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M11 8v6M8 11h6" />
              <circle cx="11" cy="11" r="7" />
              <path d="M16.5 16.5L21 21" />
            </svg>
            <span class="sr-only">Zoom in</span>
          </button>
          <button class="resource-pdf-close" type="button" data-close-modal aria-label="Close PDF preview">
            Close
          </button>
        </div>
      </header>

      <div class="resource-pdf-stage" data-stage>
        <div class="resource-pdf-strip" data-strip>
          <p class="pdf-loading">Loading preview...</p>
        </div>
      </div>

      <p class="resource-pdf-note">
        Cinema mode: use <strong>horizontal scroll</strong>, trackpad swipe, or Prev/Next.
      </p>
    </section>
  </div>
</section>

<script type="module" is:inline>
  import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.mjs';

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.mjs';

  const clamp = (value, min, max) => Math.max(min, Math.min(max, value));

  const initResourcePdfModals = () => {
    const cards = document.querySelectorAll('[data-resource-pdf]');

    cards.forEach((card) => {
      if (card.dataset.modalBound === 'true') return;
      card.dataset.modalBound = 'true';

      const pdfUrl = card.dataset.pdfUrl;
      const modal = card.querySelector('.resource-pdf-modal');
      const openButton = card.querySelector('[data-open-modal]');
      const closeButtons = card.querySelectorAll('[data-close-modal]');
      const closeButton = card.querySelector('.resource-pdf-close');
      const stage = card.querySelector('[data-stage]');
      const strip = card.querySelector('[data-strip]');
      const pageLabel = card.querySelector('[data-role="page"]');
      const zoomLabel = card.querySelector('[data-role="zoom"]');
      const prevButton = card.querySelector('[data-action="prev-page"]');
      const nextButton = card.querySelector('[data-action="next-page"]');
      const zoomOutButton = card.querySelector('[data-action="zoom-out"]');
      const zoomInButton = card.querySelector('[data-action="zoom-in"]');

      if (
        !pdfUrl ||
        !modal ||
        !openButton ||
        !closeButtons.length ||
        !closeButton ||
        !stage ||
        !strip ||
        !pageLabel ||
        !zoomLabel ||
        !prevButton ||
        !nextButton ||
        !zoomOutButton ||
        !zoomInButton
      ) {
        return;
      }

      let pdf = null;
      let pageCount = 1;
      let currentPage = 1;
      let zoom = 1;
      let rendering = false;
      let loaded = false;
      let rafId = 0;
      let pageNodes = [];

      const updateControls = () => {
        pageLabel.textContent = `${currentPage} / ${pageCount}`;
        zoomLabel.textContent = `${Math.round(zoom * 100)}%`;
        prevButton.disabled = currentPage <= 1;
        nextButton.disabled = currentPage >= pageCount;
      };

      const closestVisiblePage = () => {
        if (!pageNodes.length) return 1;
        const center = stage.scrollLeft + stage.clientWidth / 2;
        let winner = 1;
        let minDistance = Number.POSITIVE_INFINITY;

        pageNodes.forEach((node, index) => {
          const pageCenter = node.offsetLeft + node.offsetWidth / 2;
          const distance = Math.abs(center - pageCenter);
          if (distance < minDistance) {
            minDistance = distance;
            winner = index + 1;
          }
        });

        return winner;
      };

      const goToPage = (pageNumber, smooth = true) => {
        const safePage = clamp(pageNumber, 1, pageCount);
        const page = pageNodes[safePage - 1];
        if (!page) return;

        page.scrollIntoView({
          behavior: smooth ? 'smooth' : 'auto',
          block: 'nearest',
          inline: 'center',
        });

        if (!smooth) {
          const target = page.offsetLeft - (stage.clientWidth - page.offsetWidth) / 2;
          stage.scrollLeft = Math.max(0, target);
        }

        currentPage = safePage;
        updateControls();
      };

      const onStageScroll = () => {
        if (rafId) return;
        rafId = requestAnimationFrame(() => {
          rafId = 0;
          const page = closestVisiblePage();
          if (page !== currentPage) {
            currentPage = page;
            updateControls();
          }
        });
      };

      const renderDeck = async () => {
        if (!pdf || rendering) return;
        rendering = true;

        const isMobileViewport = window.matchMedia('(max-width: 640px)').matches;
        const horizontalPadding = isMobileViewport ? 24 : 120;
        const availableWidth = Math.max(220, stage.clientWidth - horizontalPadding);
        const availableHeight = Math.max(180, stage.clientHeight - 28);
        const dpr = window.devicePixelRatio || 1;
        strip.innerHTML = '';
        pageNodes = [];

        for (let index = 1; index <= pdf.numPages; index += 1) {
          const page = await pdf.getPage(index);
          const baseViewport = page.getViewport({ scale: 1 });
          const fitByWidth = availableWidth / baseViewport.width;
          const fitByHeight = availableHeight / baseViewport.height;
          const fitScale = isMobileViewport ? fitByWidth : Math.min(fitByWidth, fitByHeight);
          const scale = clamp(fitScale * zoom, 0.45, 2.2);
          const viewport = page.getViewport({ scale });

          const pageNode = document.createElement('article');
          pageNode.className = 'pdf-page';
          pageNode.dataset.page = String(index);

          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          if (!ctx) continue;

          canvas.width = Math.floor(viewport.width * dpr);
          canvas.height = Math.floor(viewport.height * dpr);
          canvas.style.width = `${Math.floor(viewport.width)}px`;
          canvas.style.height = `${Math.floor(viewport.height)}px`;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

          await page.render({ canvasContext: ctx, viewport }).promise;
          pageNode.append(canvas);
          strip.append(pageNode);
          pageNodes.push(pageNode);
        }

        pageCount = pdf.numPages;
        currentPage = 1;
        updateControls();
        goToPage(1, false);
        rendering = false;
      };

      const ensureLoaded = async () => {
        if (loaded) return;
        loaded = true;

        try {
          const loadingTask = pdfjsLib.getDocument(pdfUrl);
          pdf = await loadingTask.promise;
          await renderDeck();
        } catch {
          strip.innerHTML = '<p class="pdf-loading">Preview unavailable. Use Open PDF.</p>';
          pageCount = 1;
          currentPage = 1;
          updateControls();
        }
      };

      const closeModal = () => {
        modal.hidden = true;
        if (!document.querySelector('.resource-pdf-modal:not([hidden])')) {
          document.body.classList.remove('pdf-modal-open');
        }
      };

      openButton.addEventListener('click', async () => {
        document.querySelectorAll('.resource-pdf-modal').forEach((entry) => {
          entry.hidden = true;
        });

        modal.hidden = false;
        document.body.classList.add('pdf-modal-open');
        await ensureLoaded();
        goToPage(currentPage, false);
        closeButton.focus();
      });

      closeButtons.forEach((button) => {
        button.addEventListener('click', closeModal);
      });

      prevButton.addEventListener('click', () => {
        const onPage = closestVisiblePage();
        goToPage(onPage - 1);
      });

      nextButton.addEventListener('click', () => {
        const onPage = closestVisiblePage();
        goToPage(onPage + 1);
      });

      zoomOutButton.addEventListener('click', async () => {
        if (!pdf || rendering) return;
        zoom = clamp(zoom - 0.1, 0.6, 1.8);
        const lastPage = currentPage;
        await renderDeck();
        goToPage(lastPage, false);
      });

      zoomInButton.addEventListener('click', async () => {
        if (!pdf || rendering) return;
        zoom = clamp(zoom + 0.1, 0.6, 1.8);
        const lastPage = currentPage;
        await renderDeck();
        goToPage(lastPage, false);
      });

      stage.addEventListener('scroll', onStageScroll, { passive: true });

      window.addEventListener('resize', async () => {
        if (!modal.hidden && pdf && !rendering) {
          const lastPage = currentPage;
          await renderDeck();
          goToPage(lastPage, false);
        }
      });
    });

    if (document.documentElement.dataset.pdfEscBound === 'true') return;
    document.documentElement.dataset.pdfEscBound = 'true';

    document.addEventListener('keydown', (event) => {
      const openModal = document.querySelector('.resource-pdf-modal:not([hidden])');
      if (!openModal) return;

      if (event.key === 'Escape') {
        openModal.hidden = true;
        document.body.classList.remove('pdf-modal-open');
        return;
      }

      if (event.key === 'ArrowRight') {
        const next = openModal.querySelector('[data-action="next-page"]');
        if (next) next.click();
      }

      if (event.key === 'ArrowLeft') {
        const prev = openModal.querySelector('[data-action="prev-page"]');
        if (prev) prev.click();
      }
    });
  };

  initResourcePdfModals();
  document.addEventListener('astro:page-load', initResourcePdfModals);
  document.addEventListener('astro:after-swap', initResourcePdfModals);
</script>

<style>
  .resource-pdf {
    border: 1px solid var(--color-border);
    border-radius: 14px;
    padding: 1rem;
    margin: 1.5rem 0 2rem;
    background: color-mix(in srgb, var(--color-bg) 94%, var(--color-border));
  }

  .resource-pdf-cover {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    margin-bottom: 0.9rem;
  }

  .resource-summary {
    border: 1px solid var(--color-border);
    border-radius: 10px;
    padding: 0.8rem 0.95rem;
    margin-bottom: 0.9rem;
    background: var(--color-bg);
  }

  .resource-summary h3 {
    margin: 0 0 0.45rem;
    font-family: var(--font-serif);
    font-size: 1rem;
    color: var(--color-text-heading);
  }

  .resource-summary ul {
    margin: 0;
    padding-left: 1rem;
  }

  .resource-summary li {
    margin: 0.2rem 0;
  }

  .resource-pdf-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
  }

  .resource-pdf-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border);
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--color-text-body);
    text-decoration: none;
    background: var(--color-bg);
    cursor: pointer;
  }

  .resource-pdf-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    text-decoration: none;
  }

  .resource-pdf-btn-secondary {
    opacity: 0.92;
  }

  .resource-pdf-modal {
    position: fixed;
    inset: 0;
    z-index: 120;
    display: grid;
    place-items: center;
    padding: 1rem;
  }

  .resource-pdf-modal[hidden] {
    display: none;
  }

  .resource-pdf-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(10, 12, 18, 0.62);
  }

  .resource-pdf-panel {
    position: relative;
    z-index: 1;
    width: min(96vw, 1500px);
    max-height: calc(100vh - 2rem);
    border: 1px solid var(--color-border);
    border-radius: 14px;
    background: var(--color-bg);
    overflow: hidden;
    box-shadow: 0 22px 48px color-mix(in srgb, var(--color-text-heading) 24%, transparent);
    display: grid;
    grid-template-rows: auto 1fr auto;
  }

  .resource-pdf-header {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto;
    align-items: center;
    gap: 0.9rem;
    padding: 0.7rem 0.9rem;
    border-bottom: 1px solid var(--color-border);
    background: color-mix(in srgb, var(--color-bg) 92%, var(--color-border));
  }

  .resource-pdf-header h3 {
    margin: 0;
    font-family: var(--font-serif);
    font-size: 1.02rem;
    color: var(--color-text-heading);
    line-height: 1.3;
  }

  .resource-pdf-controls {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    justify-content: flex-end;
  }

  .resource-pdf-controls button,
  .resource-pdf-close {
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg);
    color: var(--color-text-body);
    font-family: var(--font-mono);
    font-size: 0.74rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    height: 2rem;
    min-width: 2rem;
    padding: 0 0.55rem;
    cursor: pointer;
    white-space: nowrap;
  }

  .pdf-icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    padding: 0;
  }

  .pdf-icon-btn svg {
    width: 1rem;
    height: 1rem;
    display: block;
    stroke: currentColor;
    stroke-width: 1.7;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .resource-pdf-controls button:disabled {
    opacity: 0.45;
    cursor: default;
  }

  .resource-pdf-controls button:hover,
  .resource-pdf-close:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .pdf-status {
    min-width: 3.9rem;
    height: 2rem;
    border: 1px solid transparent;
    border-radius: 8px;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    line-height: 2rem;
    color: var(--color-text-muted);
  }

  .resource-pdf-stage {
    overflow-x: auto;
    overflow-y: hidden;
    background: color-mix(in srgb, var(--color-bg) 58%, #1f2430);
    scrollbar-width: thin;
    scroll-snap-type: x mandatory;
  }

  .resource-pdf-strip {
    height: 100%;
    min-height: 100%;
    width: max-content;
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.8rem 2.25rem;
    box-sizing: border-box;
  }

  .pdf-page {
    flex: 0 0 auto;
    border: 1px solid color-mix(in srgb, var(--color-border) 75%, transparent);
    border-radius: 10px;
    overflow: hidden;
    background: #f8f8f8;
    box-shadow: 0 8px 22px rgba(0, 0, 0, 0.18);
    scroll-snap-align: center;
  }

  .pdf-page canvas {
    display: block;
  }

  .pdf-loading {
    margin: 0;
    padding: 1rem;
    color: var(--color-text-muted);
    font-size: 0.95rem;
    align-self: center;
  }

  .resource-pdf-note {
    margin: 0;
    padding: 0.55rem 0.9rem;
    border-top: 1px solid var(--color-border);
    color: var(--color-text-muted);
    font-size: 0.86rem;
  }

  :global(body.pdf-modal-open) {
    overflow: hidden;
  }

  @media (max-width: 980px) {
    .resource-pdf-panel {
      width: calc(100vw - 1rem);
      max-height: calc(100dvh - 1rem);
    }

    .resource-pdf-header {
      grid-template-columns: 1fr;
      align-items: start;
    }

    .resource-pdf-controls {
      width: 100%;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .resource-pdf-strip {
      min-height: 100%;
      padding: 0.8rem 1rem;
    }
  }

  @media (max-width: 640px) {
    .resource-pdf-modal {
      padding: 0;
    }

    .resource-pdf-panel {
      width: 100vw;
      height: 100dvh;
      max-height: 100dvh;
      border-radius: 0;
      border-left: 0;
      border-right: 0;
    }

    .resource-pdf-header {
      gap: 0.55rem;
      padding: 0.55rem 0.65rem;
    }

    .resource-pdf-header h3 {
      font-size: 0.95rem;
      line-height: 1.25;
    }

    .resource-pdf-controls {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, auto));
      justify-content: start;
      align-items: center;
      column-gap: 0.3rem;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 0.1rem;
      -webkit-overflow-scrolling: touch;
    }

    .resource-pdf-controls button,
    .resource-pdf-close {
      height: 1.9rem;
      min-width: 1.9rem;
      font-size: 0.68rem;
      letter-spacing: 0.05em;
      padding: 0 0.45rem;
    }

    .pdf-icon-btn {
      width: 1.9rem;
    }

    .pdf-status {
      min-width: 3.2rem;
      height: 1.9rem;
      line-height: 1.9rem;
      font-size: 0.72rem;
    }

    .resource-pdf-stage {
      min-height: 0;
    }

    .resource-pdf-strip {
      padding: 0.45rem 0.55rem;
      gap: 0.6rem;
    }

    .pdf-page {
      border-radius: 8px;
    }

    .resource-pdf-note {
      display: none;
    }
  }
</style>
