---
import { getCollection } from 'astro:content';
const allContent = [
  ...(await getCollection('notes')),
  ...(await getCollection('sentences')),
  ...(await getCollection('systems')),
  ...(await getCollection('self')),
  ...(await getCollection('shelf')),
];

const searchData = JSON.stringify(allContent.map(item => ({
    title: item.data.title,
    description: item.data.description || '',
    href: item.collection === 'shelf' ? `/shelf/${item.slug}` : `/${item.collection}/${item.slug}`,
})));
import searchIcon from '@/assets/search.svg?raw';
---
<div id="search-container">
    <div class="search-wrapper">
        <span class="search-icon" set:html={searchIcon}></span>
        <input type="text" id="search-input" placeholder="Search..." aria-label="Search content" autocomplete="off" spellcheck="false" />
        <button id="search-close" aria-label="Close search" type="button">&times;</button>
    </div>
    <div id="search-results" hidden></div>
</div>

<style>
    #search-container {
        position: relative;
        width: 100%;
        max-width: none;
    }
    .search-wrapper {
        position: relative;
    }
    .search-icon {
        position: absolute;
        top: 50%;
        left: 1rem;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        pointer-events: none;
    }
    .search-icon svg {
        width: 20px;
        height: 20px;
    }
    #search-input {
        width: 100%;
        padding: 0.6rem 0.9rem 0.6rem 2.6rem;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        background-color: var(--color-bg);
        color: var(--color-text-body);
        font-size: 0.95rem;
        outline: none;
    }
    #search-input:focus {
        border-color: color-mix(in srgb, var(--color-accent) 30%, var(--color-border));
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--color-accent) 18%, transparent);
    }
    #search-close {
        position: absolute;
        top: 50%;
        right: 0.85rem;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        font-size: 1.35rem;
    }
    #search-close:hover {
        color: var(--color-text-body);
    }
    #search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--color-bg);
        border: 1px solid var(--color-border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 240px;
        overflow-y: auto;
        z-index: 1;
    }
    #search-results ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #search-results li a {
        display: block;
        padding: 0.75rem 1rem;
        color: var(--color-text-body);
        text-decoration: none;
    }
    #search-results li a:hover {
        background-color: var(--color-blockquote-bg);
    }
</style>

<script type="module" define:vars={{ searchData }}>
    const allContent = JSON.parse(searchData);
    const normalise = (value) => value.toLowerCase();

    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchClose = document.getElementById('search-close');
    const searchModal = document.getElementById('search-modal');

    if (searchInput && searchResults) {
        const clearResults = () => {
            searchResults.innerHTML = '';
            searchResults.hidden = true;
        };
        const closeSearch = () => {
            if (searchModal) {
                searchModal.hidden = true;
            }
            searchInput.value = '';
            clearResults();
        };

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) {
                clearResults();
                return;
            }

            const results = allContent.filter((item) => {
                const haystack = `${item.title} ${item.description}`.toLowerCase();
                return haystack.includes(normalise(query));
            });
            if (!results.length) {
                searchResults.innerHTML = '<ul><li><span>No matches found.</span></li></ul>';
                searchResults.hidden = false;
                return;
            }

            let resultsHtml = '<ul>';
            results.slice(0, 10).forEach(result => {
                resultsHtml += `<li><a href="${result.href}" data-search-result>${result.title}</a></li>`;
            });
            resultsHtml += '</ul>';
            searchResults.innerHTML = resultsHtml;
            searchResults.hidden = false;
        });

        if (searchClose) {
            searchClose.addEventListener('click', () => {
                closeSearch();
            });
        }
        searchResults.addEventListener('click', (event) => {
            const target = event.target;
            if (target instanceof HTMLElement && target.closest('[data-search-result]')) {
                closeSearch();
            }
        });
    }
</script>
